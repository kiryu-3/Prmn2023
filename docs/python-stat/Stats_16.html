<!DOCTYPE html>
<html>
<head>
<title>Stats_16.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E5%88%86%E6%95%A3%E5%88%86%E6%9E%901">分散分析1</h1>
<ul>
<li><a href="#%E5%88%86%E6%95%A3%E5%88%86%E6%9E%901">分散分析1</a>
<ul>
<li><a href="#%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E3%81%A8%E3%81%AF">分散分析とは</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E8%AA%9E">基本用語</a></li>
<li><a href="#%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E3%81%AE%E7%A8%AE%E9%A1%9E">分散分析の種類</a></li>
</ul>
</li>
<li><a href="#%E4%B8%80%E5%85%83%E9%85%8D%E7%BD%AE%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">一元配置分散分析</a>
<ul>
<li><a href="#%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E8%A1%A8">分散分析表</a></li>
<li><a href="#%E6%BC%94%E7%BF%92">演習</a></li>
<li><a href="#%E4%BB%AE%E8%AA%AC%E6%A4%9C%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E5%86%8D%E6%8E%B2">仮説検定のステップ（再掲）</a>
<ul>
<li><a href="#%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%81%A8%E5%AF%BE%E7%AB%8B%E4%BB%AE%E8%AA%AC%E3%82%92%E7%AB%8B%E3%81%A6%E3%82%8B">帰無仮説と対立仮説を立てる</a></li>
<li><a href="#%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%81%AE%E3%82%82%E3%81%A8%E3%81%A7%E6%A8%99%E6%9C%AC%E8%A6%B3%E5%AF%9F%E3%82%92%E8%A1%8C%E3%81%86">帰無仮説のもとで標本観察を行う</a>
<ul>
<li><a href="#%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%A8%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%AE%E5%B0%8E%E5%87%BA">全体平均と各群の平均値の導出</a></li>
<li><a href="#%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%8B%E3%82%89%E5%90%84%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BA%E3%83%AC">全体平均から各データのズレ</a></li>
<li><a href="#%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%8B%E3%82%89%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%AE%E3%82%BA%E3%83%AC">全体平均から各群の平均値のズレ</a></li>
<li><a href="#%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%8B%E3%82%89%E5%90%84%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BA%E3%83%AC">各群の平均値から各データのズレ</a></li>
<li><a href="#%E8%87%AA%E7%94%B1%E5%BA%A6%E3%81%8B%E3%82%89%E5%B9%B3%E5%9D%87%E5%B9%B3%E6%96%B9">自由度から平均平方</a></li>
<li><a href="#%E7%B5%B1%E8%A8%88%E9%87%8Ff">統計量$F$</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%82%92%E6%A3%84%E5%8D%B4%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">帰無仮説を棄却できるかどうかを確認する</a></li>
</ul>
</li>
<li><a href="#python%E3%81%AB%E3%82%88%E3%82%8B%E4%B8%80%E5%85%83%E9%85%8D%E7%BD%AE%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">Pythonによる一元配置分散分析</a></li>
<li><a href="#%E9%83%BD%E9%81%93%E5%BA%9C%E7%9C%8C%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A7%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">都道府県データで分散分析</a></li>
<li><a href="#%E5%A4%9A%E9%87%8D%E6%AF%94%E8%BC%83%E6%B3%95">多重比較法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats
<span class="hljs-keyword">from</span> statsmodels.formula.api <span class="hljs-keyword">import</span> ols
<span class="hljs-keyword">from</span> statsmodels.stats.multicomp <span class="hljs-keyword">import</span> pairwise_tukeyhsd
<span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm
<span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> f
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal, ROUND_HALF_UP, ROUND_HALF_EVEN
</div></code></pre>
<div style="page-break-before:always"></div>
<h2 id="%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E3%81%A8%E3%81%AF">分散分析とは</h2>
<p>平均値の差の検定において、3群以上からなるデータに対しては<br>
（推定の多重性のため）$t$検定を行うことができません。</p>
<p>このような場合にも対応できる、<br>
「分散の比」を考えて平均値の差を検定する分析手法を<strong>分散分析</strong>といいます。</p>
<h3 id="%E5%9F%BA%E6%9C%AC%E7%94%A8%E8%AA%9E">基本用語</h3>
<ul>
<li><strong>要因</strong>：データの値に変化を与える要素のこと</li>
<li><strong>因子</strong>：要因の中でも特に、母平均に差をもたらすと考えられることから注目する要因</li>
<li><strong>水準</strong>：1つの要因に含まれる項目のこと</li>
<li><strong>〇元配置</strong>：データに含まれる因子の数を表すもの</li>
</ul>
<h3 id="%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E3%81%AE%E7%A8%AE%E9%A1%9E">分散分析の種類</h3>
<p>分散分析にはいくつかの種類があります。</p>
<ul>
<li>
<p>「一元配置分散分析」：1つの因子からデータを分析する方法。<br>
　　　　　　　　　　　因子に含まれる水準間の平均値の差を見ることができる。</p>
</li>
<li>
<p>「二元配置分散分析」：2つの因子からなるデータを分析する方法。<br>
　　　　　　　　　　　各因子における水準間の平均値の差を見ることができる。<br>
　　　　　　　　　　　また、2つの要因が組み合わさることで現れる相乗効果の有無も確認できる。</p>
</li>
<li>
<p>「多元配置分散分析」：3つ以上の因子からなるデータを分析する方法。</p>
</li>
</ul>
<div style="page-break-before:always"></div>
<h2 id="%E4%B8%80%E5%85%83%E9%85%8D%E7%BD%AE%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">一元配置分散分析</h2>
<p>分散分析では、「全体平均から因子の各水準の平均値がどの程度ズレているか」に注目します。</p>
<p>ズレは以下の式で表すことができます。</p>
<p>「全体平均から各データのズレ」=「全体平均から各群の平均値のズレ」 + 「各群の平均値から各データのズレ」</p>
<p>これらのズレを二乗和として求めます。</p>
<h3 id="%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90%E8%A1%A8">分散分析表</h3>
<p>分散分析では、<strong>分散分析表</strong>という表を用いて、結果を分かりやすく表現することが多いです。</p>
<p>一元配置分散分析の分散分析表は以下の通りです。</p>
<table>
<thead>
<tr>
<th style="text-align:center">因子</th>
<th style="text-align:center">平方和</th>
<th style="text-align:center">自由度</th>
<th style="text-align:center">平均平方</th>
<th style="text-align:center">F値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">要因</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">残差</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">全体</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>「平方和」の部分にはそれぞれのズレの二乗和が入ります。</p>
<ul>
<li>「要因」：全体平均から各群の平均値のズレ</li>
<li>「残差」：各群の平均値から各データのズレ</li>
<li>「全体」：全体平均から各データのズレ</li>
</ul>
<p>「自由度」は以下のものが入ります。</p>
<ul>
<li>「要因」：因子の水準の個数から1を引いたもの</li>
<li>「残差」：全体の自由度から要因の自由度を引いたもの</li>
<li>「全体」：すべてのデータの個数から1を引いたもの</li>
</ul>
<p>「平均平方」には「平方和」を「自由度」で割ったものが入ります。</p>
<p>最後に「要因の平均平方」を分子に、「残差の平均平方」を分母にして<br>
統計量$F$を算出します。</p>
<div style="page-break-before:always"></div>
<h3 id="%E6%BC%94%E7%BF%92">演習</h3>
<p>まずは<a href="https://bit.ly/3Y7Hzup">こちら</a>の例題について、分散分析を行ってみます。</p>
<pre class="hljs"><code><div>df = pd.read_excel(<span class="hljs-string">"movie_theatre.xlsx"</span>)
df.iloc[[<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">14</span>]]
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>21</td>
    </tr>
    <tr>
      <th>7</th>
      <td>関東</td>
      <td>92</td>
    </tr>
    <tr>
      <th>14</th>
      <td>中部</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
<p>ここで用語について整理します。</p>
<ul>
<li><strong>要因</strong>：「映画館の数」に変化を与える要素のこと。<br>
　　　　今回の場合は、「地方」のほかに「人口」など様々なものが考えられる。</li>
<li><strong>因子</strong>：要因の中でも特に、「映画館の数」の母平均に差をもたらすと考えられる「地方」のこと。</li>
<li><strong>水準</strong>：今回の場合は、7つの地方に分けられるので水準数は「7」。</li>
<li><strong>一元配置</strong>：今回は因子が「地方」のみであるので「一元配置」。</li>
</ul>
<h3 id="%E4%BB%AE%E8%AA%AC%E6%A4%9C%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E5%86%8D%E6%8E%B2">仮説検定のステップ（再掲）</h3>
<p>①帰無仮説と対立仮説を立てる<br>
②帰無仮説のもとで標本観察を行う<br>
③帰無仮説を棄却できるかどうかを確認する</p>
<div style="page-break-before:always"></div>
<h4 id="%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%81%A8%E5%AF%BE%E7%AB%8B%E4%BB%AE%E8%AA%AC%E3%82%92%E7%AB%8B%E3%81%A6%E3%82%8B">帰無仮説と対立仮説を立てる</h4>
<p>帰無仮説と対立仮説は以下のようになります。（<strong>片側検定（上側）</strong> になります）</p>
<p>帰無仮説$H_0$：「各地方の映画館数の母平均は等しい」<br>
対立仮説$H_1$：「各地方の映画館数の母平均では差がある」</p>
<p>分散分析では「残差のばらつき」に対して「要因のばらつき」が大きいかどうかを検定するため、<br>
必ず「片側検定」を行います。</p>
<h4 id="%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%81%AE%E3%82%82%E3%81%A8%E3%81%A7%E6%A8%99%E6%9C%AC%E8%A6%B3%E5%AF%9F%E3%82%92%E8%A1%8C%E3%81%86">帰無仮説のもとで標本観察を行う</h4>
<h5 id="%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%A8%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%AE%E5%B0%8E%E5%87%BA">全体平均と各群の平均値の導出</h5>
<p>以下のようになります。</p>
<pre class="hljs"><code><div>df[<span class="hljs-string">"映画館の数"</span>].mean()
</div></code></pre>
<pre><code>9.382978723404255
</code></pre>
<pre class="hljs"><code><div>new_df = df.groupby(<span class="hljs-string">"地方"</span>).mean()
new_df = new_df.reindex(index=df[<span class="hljs-string">"地方"</span>].unique())
new_df = new_df.reset_index()
new_df
</div></code></pre>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>9.285714</td>
    </tr>
    <tr>
      <th>1</th>
      <td>関東</td>
      <td>19.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>中部</td>
      <td>8.111111</td>
    </tr>
    <tr>
      <th>3</th>
      <td>近畿</td>
      <td>12.428571</td>
    </tr>
    <tr>
      <th>4</th>
      <td>中国</td>
      <td>5.400000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>四国</td>
      <td>2.250000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>九州・沖縄</td>
      <td>5.875000</td>
    </tr>
  </tbody>
</table>
</div>
<div style="page-break-before:always"></div>
<h5 id="%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%8B%E3%82%89%E5%90%84%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BA%E3%83%AC">全体平均から各データのズレ</h5>
<p>このズレの二乗和を求めます。</p>
<pre class="hljs"><code><div>df[<span class="hljs-string">"全体平均 - 各データ"</span>] = (df[<span class="hljs-string">"映画館の数"</span>] - df[<span class="hljs-string">"映画館の数"</span>].mean())**<span class="hljs-number">2</span>
df.iloc[[<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">14</span>]]
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
      <th>全体平均 - 各データ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>21</td>
      <td>134.955183</td>
    </tr>
    <tr>
      <th>7</th>
      <td>関東</td>
      <td>92</td>
      <td>6825.572205</td>
    </tr>
    <tr>
      <th>14</th>
      <td>中部</td>
      <td>2</td>
      <td>54.508375</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="hljs"><code><div>round(sum(df[<span class="hljs-string">"全体平均 - 各データ"</span>]),<span class="hljs-number">2</span>)
</div></code></pre>
<pre><code>9085.11
</code></pre>
<div style="page-break-before:always"></div>
<h5 id="%E5%85%A8%E4%BD%93%E5%B9%B3%E5%9D%87%E3%81%8B%E3%82%89%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%AE%E3%82%BA%E3%83%AC">全体平均から各群の平均値のズレ</h5>
<p>このズレの二乗和を求めます。</p>
<pre class="hljs"><code><div>goukei = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(df[<span class="hljs-string">"映画館の数"</span>])):
  <span class="hljs-keyword">if</span> df.loc[i][<span class="hljs-string">"地方"</span>] <span class="hljs-keyword">in</span> new_df[<span class="hljs-string">"地方"</span>].unique():
    goukei.append(float(new_df[new_df[<span class="hljs-string">"地方"</span>]  == df.loc[i][<span class="hljs-string">"地方"</span>]][<span class="hljs-string">"映画館の数"</span>]))

df[<span class="hljs-string">"各群の平均値"</span>] = pd.Series(goukei)
df.iloc[[<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">14</span>]]
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
      <th>全体平均 - 各データ</th>
      <th>各群の平均値</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>21</td>
      <td>134.955183</td>
      <td>9.285714</td>
    </tr>
    <tr>
      <th>7</th>
      <td>関東</td>
      <td>92</td>
      <td>6825.572205</td>
      <td>19.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>中部</td>
      <td>2</td>
      <td>54.508375</td>
      <td>8.111111</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="hljs"><code><div>df[<span class="hljs-string">"全体平均 - 各地方の平均"</span>] = (df[<span class="hljs-string">"映画館の数"</span>].mean() - df[<span class="hljs-string">"各群の平均値"</span>])**<span class="hljs-number">2</span>
df.iloc[[<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">14</span>]]
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
      <th>全体平均 - 各データ</th>
      <th>各群の平均値</th>
      <th>全体平均 - 各地方の平均</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>21</td>
      <td>134.955183</td>
      <td>9.285714</td>
      <td>0.009460</td>
    </tr>
    <tr>
      <th>7</th>
      <td>関東</td>
      <td>92</td>
      <td>6825.572205</td>
      <td>19.000000</td>
      <td>92.487098</td>
    </tr>
    <tr>
      <th>14</th>
      <td>中部</td>
      <td>2</td>
      <td>54.508375</td>
      <td>8.111111</td>
      <td>1.617647</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="hljs"><code><div>round(sum(df[<span class="hljs-string">"全体平均 - 各地方の平均"</span>]),<span class="hljs-number">2</span>)
</div></code></pre>
<pre><code>1108.25
</code></pre>
<div style="page-break-before:always"></div>
<h5 id="%E5%90%84%E7%BE%A4%E3%81%AE%E5%B9%B3%E5%9D%87%E5%80%A4%E3%81%8B%E3%82%89%E5%90%84%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BA%E3%83%AC">各群の平均値から各データのズレ</h5>
<p>引き算をすることで求めます。</p>
<pre class="hljs"><code><div>round(sum(df[<span class="hljs-string">"全体平均 - 各データ"</span>]),<span class="hljs-number">2</span>) - round(sum(df[<span class="hljs-string">"全体平均 - 各地方の平均"</span>]),<span class="hljs-number">2</span>)
</div></code></pre>
<pre><code>7976.860000000001
</code></pre>
<h5 id="%E8%87%AA%E7%94%B1%E5%BA%A6%E3%81%8B%E3%82%89%E5%B9%B3%E5%9D%87%E5%B9%B3%E6%96%B9">自由度から平均平方</h5>
<p>ここまで分かったことを、分散分析表にまとめていきます。</p>
<table>
<thead>
<tr>
<th style="text-align:center">因子</th>
<th style="text-align:center">平方和</th>
<th style="text-align:center">自由度</th>
<th style="text-align:center">平均平方</th>
<th style="text-align:center">F値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">要因</td>
<td style="text-align:center">1108.25</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">残差</td>
<td style="text-align:center">7976.86</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">全体</td>
<td style="text-align:center">9085.11</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>自由度、平均平方もすぐ求められます。</p>
<table>
<thead>
<tr>
<th style="text-align:center">因子</th>
<th style="text-align:center">平方和</th>
<th style="text-align:center">自由度</th>
<th style="text-align:center">平均平方</th>
<th style="text-align:center">F値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">要因</td>
<td style="text-align:center">1108.25</td>
<td style="text-align:center">6</td>
<td style="text-align:center">184.71</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">残差</td>
<td style="text-align:center">7976.86</td>
<td style="text-align:center">40</td>
<td style="text-align:center">199.42</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">全体</td>
<td style="text-align:center">9085.11</td>
<td style="text-align:center">46</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h5 id="%E7%B5%B1%E8%A8%88%E9%87%8Ff">統計量$F$</h5>
<p>要因の平均平方を「分子」、残差の平均平方を「分母」として、<br>
統計量$F$を算出します。</p>
<p>$$
F = \frac{s^2_1}{s^2_2} = \frac{184.71}{199.42} = 0.926
$$</p>
<table>
<thead>
<tr>
<th style="text-align:center">因子</th>
<th style="text-align:center">平方和</th>
<th style="text-align:center">自由度</th>
<th style="text-align:center">平均平方</th>
<th style="text-align:center">F値</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">要因</td>
<td style="text-align:center">1108.25</td>
<td style="text-align:center">6</td>
<td style="text-align:center">184.71</td>
<td style="text-align:center">0.926</td>
</tr>
<tr>
<td style="text-align:center">残差</td>
<td style="text-align:center">7976.86</td>
<td style="text-align:center">40</td>
<td style="text-align:center">199.42</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">全体</td>
<td style="text-align:center">9085.11</td>
<td style="text-align:center">46</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<div style="page-break-before:always"></div>
<h4 id="%E5%B8%B0%E7%84%A1%E4%BB%AE%E8%AA%AC%E3%82%92%E6%A3%84%E5%8D%B4%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">帰無仮説を棄却できるかどうかを確認する</h4>
<p>有意水準を$5$%に設定します。</p>
<p>($p$<strong>値を求めて</strong>) 棄却が必要かどうか決めます。</p>
<pre class="hljs"><code><div>fk = stats.f(dfn=<span class="hljs-number">6</span> , dfd=<span class="hljs-number">40</span>).ppf(<span class="hljs-number">0.95</span>)
fk
</div></code></pre>
<pre><code>2.335852404791663
</code></pre>
<pre class="hljs"><code><div>nyp = float(Decimal(str(stats.f(dfn=<span class="hljs-number">6</span> , dfd=<span class="hljs-number">40</span>).sf(fk)*<span class="hljs-number">100</span>)).
            quantize(Decimal(<span class="hljs-string">'0.001'</span>),rounding=ROUND_HALF_UP))
print(<span class="hljs-string">f"有意水準：<span class="hljs-subst">{nyp}</span>%"</span>)    <span class="hljs-comment"># 右側の棄却域の面積</span>

nkp = float(Decimal(str(stats.f(dfn=<span class="hljs-number">6</span> , dfd=<span class="hljs-number">40</span>).sf(<span class="hljs-number">0.926</span>)*<span class="hljs-number">100</span>)).
            quantize(Decimal(<span class="hljs-string">'0.000001'</span>),rounding=ROUND_HALF_UP))
print(<span class="hljs-string">f"p値：<span class="hljs-subst">{nkp}</span>%"</span>)
</div></code></pre>
<pre><code>有意水準：5.0%
p値：48.682816%
</code></pre>
<pre class="hljs"><code><div>print(<span class="hljs-string">"p値が有意水準より大きくなったので、帰無仮説を棄却せず、対立仮説を採択しない"</span>)
print(<span class="hljs-string">"したがって、地方によって映画館の数の母平均に差があるとはいえない"</span>)
</div></code></pre>
<div style="page-break-before:always"></div>
<h3 id="python%E3%81%AB%E3%82%88%E3%82%8B%E4%B8%80%E5%85%83%E9%85%8D%E7%BD%AE%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">Pythonによる一元配置分散分析</h3>
<p>と、ここまで結構ステップを踏んできましたが、<br>
Pythonでは簡単に分散分析表を求めることができます。</p>
<pre class="hljs"><code><div>df = pd.read_excel(<span class="hljs-string">"movie_theatre.xlsx"</span>)
df.iloc[[<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">14</span>]]
</div></code></pre>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>映画館の数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北</td>
      <td>21</td>
    </tr>
    <tr>
      <th>7</th>
      <td>関東</td>
      <td>92</td>
    </tr>
    <tr>
      <th>14</th>
      <td>中部</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="hljs"><code><div>model = ols(<span class="hljs-string">'映画館の数 ~ 地方'</span>, data=df).fit()
anova = sm.stats.anova_lm(model, typ=<span class="hljs-number">2</span>)
anova  
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum_sq</th>
      <th>df</th>
      <th>F</th>
      <th>PR(&gt;F)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>地方</th>
      <td>1108.249637</td>
      <td>6.0</td>
      <td>0.926221</td>
      <td>0.48668</td>
    </tr>
    <tr>
      <th>Residual</th>
      <td>7976.856746</td>
      <td>40.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
<p>$F$値と$P$値を簡単に求めることができました。</p>
<div style="page-break-before:always"></div>
<h3 id="%E9%83%BD%E9%81%93%E5%BA%9C%E7%9C%8C%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A7%E5%88%86%E6%95%A3%E5%88%86%E6%9E%90">都道府県データで分散分析</h3>
<p>男性の平均睡眠時間について、地方間で差があるかどうかを検定します。</p>
<p><code>todohuken_kaidata.csv</code>をインポートしてください。</p>
<pre class="hljs"><code><div>df = pd.read_csv(<span class="hljs-string">"todohuken_kaidata.csv"</span>)
df = df[[<span class="hljs-string">"地方"</span>,<span class="hljs-string">"15歳以上の平均睡眠時間（男）"</span>]]
df.head(<span class="hljs-number">3</span>)
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>15歳以上の平均睡眠時間（男）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道地方</td>
      <td>473</td>
    </tr>
    <tr>
      <th>1</th>
      <td>東北地方</td>
      <td>486</td>
    </tr>
    <tr>
      <th>2</th>
      <td>東北地方</td>
      <td>477</td>
    </tr>
  </tbody>
</table>
</div>
<p>北海道は東北地方と混ぜてしまいます。</p>
<pre class="hljs"><code><div><span class="hljs-keyword">for</span> idx,row <span class="hljs-keyword">in</span> df.iterrows():  <span class="hljs-comment"># rowには各行のSeriesが⼊る</span>
 <span class="hljs-keyword">if</span> row[<span class="hljs-string">"地方"</span>] <span class="hljs-keyword">in</span> [<span class="hljs-string">"北海道地方"</span>,<span class="hljs-string">"東北地方"</span>]: 
  row[<span class="hljs-string">"地方"</span>] = <span class="hljs-string">"北海道・東北地方"</span>
  df.iloc[idx] = row

df.head(<span class="hljs-number">3</span>)
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>地方</th>
      <th>15歳以上の平均睡眠時間（男）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北地方</td>
      <td>473</td>
    </tr>
    <tr>
      <th>1</th>
      <td>北海道・東北地方</td>
      <td>486</td>
    </tr>
    <tr>
      <th>2</th>
      <td>北海道・東北地方</td>
      <td>477</td>
    </tr>
  </tbody>
</table>
</div>
<div style="page-break-before:always"></div>
<p>エラーを解消する目的で、カラム名を変更します。</p>
<pre class="hljs"><code><div>df = df.rename(columns={<span class="hljs-string">'地方'</span>: <span class="hljs-string">'region'</span>, 
                   <span class="hljs-string">'15歳以上の平均睡眠時間（男）'</span>: <span class="hljs-string">'average_sleep_time_male'</span>})
df.head(<span class="hljs-number">3</span>)
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>region</th>
      <th>average_sleep_time_male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>北海道・東北地方</td>
      <td>473</td>
    </tr>
    <tr>
      <th>1</th>
      <td>北海道・東北地方</td>
      <td>486</td>
    </tr>
    <tr>
      <th>2</th>
      <td>北海道・東北地方</td>
      <td>477</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="hljs"><code><div>model = ols(<span class="hljs-string">'average_sleep_time_male~region'</span>, data=df).fit()
anova = sm.stats.anova_lm(model, typ=<span class="hljs-number">2</span>)
anova
</div></code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum_sq</th>
      <th>df</th>
      <th>F</th>
      <th>PR(&gt;F)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>region</th>
      <td>1601.791734</td>
      <td>6.0</td>
      <td>8.445456</td>
      <td>0.000006</td>
    </tr>
    <tr>
      <th>Residual</th>
      <td>1264.421032</td>
      <td>40.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
<p>$P$値がとても小さくなったので、帰無仮説を棄却できそうです。</p>
<p>よって、地方ごとに平均睡眠時間に差があるといえます。</p>
<div style="page-break-before:always"></div>
<h3 id="%E5%A4%9A%E9%87%8D%E6%AF%94%E8%BC%83%E6%B3%95">多重比較法</h3>
<p>かなり難しいので、説明は省略します。
（<a href="https://bellcurve.jp/statistics/blog/14439.html">こちら</a>などに解説があります）
具体的にどの群の間に差異が存在するのかを検定することができます。</p>
<pre class="hljs"><code><div>print(pairwise_tukeyhsd(df[<span class="hljs-string">"average_sleep_time_male"</span>], df[<span class="hljs-string">"region"</span>]))
</div></code></pre>
<pre><code>   Multiple Comparison of Means - Tukey HSD, FWER=0.05    
==========================================================
 group1   group2  meandiff p-adj   lower    upper   reject
----------------------------------------------------------
    中国地方     中部地方  -2.3111    0.9 -12.0426   7.4203  False
    中国地方     九州地方    0.175    0.9  -9.7713  10.1213  False
    中国地方 北海道・東北地方   8.2286 0.1867  -1.9873  18.4445  False
    中国地方     四国地方      2.8    0.9  -8.9038  14.5038  False
    中国地方     近畿地方  -5.7714 0.5752 -15.9873   4.4445  False
    中国地方     関東地方 -11.4857 0.0188 -21.7016  -1.2698   True
    中部地方     九州地方   2.4861    0.9  -5.9916  10.9638  False
    中部地方 北海道・東北地方  10.5397 0.0101   1.7472  19.3321   True
    中部地方     四国地方   5.1111 0.7102  -5.3732  15.5954  False
    中部地方     近畿地方  -3.4603  0.874 -12.2528   5.3321  False
    中部地方     関東地方  -9.1746 0.0359 -17.9671  -0.3822   True
    九州地方 北海道・東北地方   8.0536  0.108  -0.9761  17.0832  False
    九州地方     四国地方    2.625    0.9   -8.059   13.309  False
    九州地方     近畿地方  -5.9464 0.4067 -14.9761   3.0832  False
    九州地方     関東地方 -11.6607 0.0045 -20.6904   -2.631   True
北海道・東北地方     四国地方  -5.4286 0.6946  -16.364   5.5069  False
北海道・東北地方     近畿地方    -14.0  0.001 -23.3258  -4.6742   True
北海道・東北地方     関東地方 -19.7143  0.001 -29.0401 -10.3885   True
    四国地方     近畿地方  -8.5714 0.2122 -19.5069    2.364  False
    四国地方     関東地方 -14.2857 0.0039 -25.2212  -3.3502   True
    近畿地方     関東地方  -5.7143 0.4915 -15.0401   3.6115  False
----------------------------------------------------------
</code></pre>
<p>有意差ありの場合、項目<code>reject</code>がTrueになるようです。<br>
Trueになった項目を以下にまとめます。</p>
<ul>
<li>関東地方 ⇔ 北海道・東北地方</li>
<li>関東地方 ⇔ 中部地方</li>
<li>関東地方 ⇔ 中国地方</li>
<li>関東地方 ⇔ 四国地方</li>
<li>関東地方 ⇔ 九州地方</li>
<li>中部地方 ⇔ 北海道・東北地方</li>
<li>近畿地方 ⇔ 北海道・東北地方</li>
</ul>
<p>なんとなく都心と田舎の特徴が出ている気がしますね。</p>

</body>
</html>
